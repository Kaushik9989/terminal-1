<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Droppoint — Verify OTP</title>
  
  <!-- Default to light; still readable for users with dark preference -->
  <meta name="color-scheme" content="light">
  <meta name="theme-color" content="#ffffff"/>

  <style>
    /* =============================
       Design tokens (light-first)
       ============================= */
    :root{
      --brand: #ff7b00;
      --brand-600: #ff7b00;
      --brand-700: #e56e00;
      --ink: #111111;
      --muted: #6b7280;
      --bg: #ffffff;
      --bg-subtle: #f9fafb;
      --elev: #ffffff;
      --border: #e7e7ec;
      --success: #16a34a;
      --danger: #dc2626;

      --radius: 16px;
      --radius-sm: 12px;
      --touch: 56px;

      --shadow-sm: 0 2px 8px rgba(16,24,40,.06);
      --shadow-md: 0 14px 34px rgba(16,24,40,.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    /* Full centered layout (kiosk-friendly) */
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--ink);
      background:
        radial-gradient(1200px 800px at 80% -10%, rgba(255,123,0,.06), transparent 55%),
        radial-gradient(900px 600px at -10% 90%, var(--bg-subtle), transparent 60%),
        var(--bg);
      display:grid; place-items:center;
      padding: 20px env(safe-area-inset-left) 24px env(safe-area-inset-right);
      overflow:hidden;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    .verify-card{
      width:100%; max-width:760px; /* NEW: widened to fit keypad on desktop */
      border-radius:var(--radius);
      padding: clamp(20px,4.5vw,32px);
      background:
        linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.9)) padding-box,
        linear-gradient(180deg, rgba(255,123,0,.22), rgba(255,123,0,0)) border-box;
      border:1px solid transparent;
      box-shadow: var(--shadow-md);
      backdrop-filter: saturate(1.1) blur(6px);
      -webkit-backdrop-filter: saturate(1.1) blur(6px);
      text-align:center;
      position:relative;
    }

    .logo{
      width:140px; height:auto; display:inline-block; margin-bottom:14px;
    }

    h3{ margin:6px 0 6px; font-size: clamp(1.15rem, 2.2vw, 1.5rem); font-weight:800; letter-spacing:-.01em; }
    .lead{ color:var(--muted); margin:0 0 16px; }

    .alerts{ margin: 8px 0 12px; text-align:left; display:grid; gap:8px; }
    .alert{ padding:10px 12px; border-radius:10px; font-weight:600; border:1px solid var(--border); }
    .alert.info{ background:#fff7e6; color:#8b4b00; }
    .alert.error{ background:#ffe9e6; color:#8b1c1c; }

    /* Phone row (read-only) */
    .field-label{ display:block; font-size:.9rem; color:var(--muted); margin:10px 0 6px; text-align:left; }
    .phone-row{ display:flex; gap:10px; align-items:center; }
    .chip{ display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:12px; background:var(--bg-subtle); border:1px solid var(--border); font-weight:700; }
    .chip small{ font-weight:600; color:var(--muted) }
    .chip strong{ letter-spacing:.02em; }
    .change-link{ margin-left:auto; font-weight:700; color:var(--ink); text-decoration:none; border-bottom:1px dashed currentColor; }
    .change-link:hover{ opacity:.9 }

    /* OTP + Keypad wrap (NEW) */
    .otp-wrap{ /* NEW: two-column layout on wide screens */
      display:grid; gap:16px; align-items:start; margin-top:8px;
    }
    @media (min-width: 760px){
      .otp-wrap{
        grid-template-columns: 1fr 300px; /* OTP area | keypad */
      }
    }

    /* OTP input group (6 boxes) */
    .otp-grid{ display:grid; grid-template-columns: repeat(6, 1fr); gap:10px; margin:12px 0 8px; }
    .otp-cell{
      width: 70px;
      height:58px; border-radius:12px; border:1px solid var(--border); background:linear-gradient(180deg,var(--elev),var(--bg-subtle));
      font-size:1.35rem; font-weight:800; text-align:center; letter-spacing:.02em; outline: none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.6), var(--shadow-sm);
    }
    .otp-cell:focus{ outline:3px solid rgba(255,123,0,.18); outline-offset:1px; }

    .btn-row{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top:12px; }
    .btn{ height:var(--touch); border-radius:12px; border:1px solid transparent; display:inline-flex; align-items:center; justify-content:center; gap:10px; cursor:pointer; font-weight:800; letter-spacing:.02em; box-shadow:var(--shadow-sm); }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ color:#fff; background: linear-gradient(180deg, color-mix(in oklab, var(--brand-600) 96%, white), var(--brand-700)); }
    .btn-ghost{ background:transparent; color:var(--ink); border-color:var(--border); }

    .subtle{ color:var(--muted); font-size:.92rem; margin-top:8px; }
    .countdown{ font-weight:800; color:var(--muted); margin-left:4px; }

    .footer{ margin-top:14px; color:var(--muted); font-size:.92rem; }

    /* Focus styles */
    .btn:focus, .change-link:focus { outline:3px solid rgba(255,123,0,.18); outline-offset:2px; }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){ *{transition:none !important; animation:none !important;} }

    @media (max-width:560px){
      .verify-card{ border-radius:12px; }
      .otp-cell{ height:52px; font-size:1.2rem; }
    }
      
    /* Back button */
    .back {
      position: absolute;
      left: 14px;
      top: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      height: 40px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--bg), var(--bg-subtle));
      color: var(--ink);
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
    }
    .back:active { transform: translateY(1px); }
    .back:hover { border-color: color-mix(in oklab, var(--brand-600) 25%, var(--border)); }
    .back svg { width: 18px; height: 18px; display: block; }

    /* =============================
       Virtual Keypad (NEW)
       ============================= */
    .keypad{
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--elev), var(--bg-subtle));
      box-shadow: var(--shadow-sm);
      padding: 12px;
      text-align:left;
    }
    .keypad h4{
      margin: 2px 0 10px;
      font-size: .95rem;
      color: var(--muted);
      font-weight: 700;
    }
    .key-grid{
      display:grid; grid-template-columns:repeat(3,1fr); gap:10px;
    }
    .key{
      user-select:none; -webkit-user-select:none;
      display:inline-flex; align-items:center; justify-content:center;
      height:56px; border-radius:12px; border:1px solid var(--border);
      background: linear-gradient(180deg, var(--bg), var(--bg-subtle));
      box-shadow: var(--shadow-sm);
      font-weight:800; font-size:1.05rem; cursor:pointer;
      transition: transform .08s ease, filter .2s ease, box-shadow .2s ease;
    }
    .key:active{ transform: translateY(1px); }
    .key.action{ background: linear-gradient(180deg, color-mix(in oklab, var(--brand-600) 12%, var(--bg)), var(--bg-subtle)); font-weight:700; }
    .key.wide{ grid-column: span 2; }
    .key svg{ width:20px; height:20px; }
    .key[disabled]{ opacity:.5; cursor:not-allowed; }
  </style>
</head>
<body>
  <div class="verify-card" role="main">
    <button id="backBtn" class="back" aria-label="Go back">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false">
        <path d="M15 6 L9 12 L15 18" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
      Back
    </button>
    <img src="/images/droppointlogo.png" alt="Droppoint" class="logo" />

    <h3 id="verify-heading">Verify your phone</h3>
    <p class="lead">Enter the OTP sent to your phone to continue.</p>

    <div class="alerts" aria-live="polite">
      <% if (typeof message !== 'undefined' && message) { %>
        <div class="alert info"><%= message %></div>
      <% } %>
      <% if (typeof error !== 'undefined' && error) { %>
        <div class="alert error"><%= error %></div>
      <% } %>
    </div>

    <!-- Phone (read-only) and change link -->
    <label class="field-label">Phone</label>
    <div class="phone-row">
      <div class="chip" aria-label="phone number">
        <small>+91</small>
        <strong><%= phone %></strong>
      </div>
      <a class="change-link" href="/dropoff" aria-label="Change phone number">Change</a>
    </div>

    <!-- VERIFY FORM -->
    <form id="verifyForm" method="post" action="/terminal/whatsapp/verify-otp" autocomplete="off" novalidate>
      <input type="hidden" name="phone" value="<%= phone %>" />
      <input type="hidden" id="code" name="code" value="" />

      <label class="field-label" for="otp-1">Enter OTP</label>

      <!-- OTP + KEYPAD WRAP (NEW) -->
      <div class="otp-wrap">
        <!-- Left: OTP cells -->
        <div>
          <div class="otp-grid" role="group" aria-label="One-time passcode">
            <input id="otp-1" class="otp-cell" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" autocomplete="one-time-code" />
            <input id="otp-2" class="otp-cell" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" />
            <input id="otp-3" class="otp-cell" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" />
            <input id="otp-4" class="otp-cell" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" />
            <input id="otp-5" class="otp-cell" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" />
            <input id="otp-6" class="otp-cell" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" />
          </div>
          <div class="btn-row">
            <button type="submit" class="btn btn-primary" id="verifyBtn">Verify</button>
          </div>
        </div>

        <!-- Right: Virtual Keypad (NEW) -->
        <section class="keypad" aria-label="Virtual keypad for OTP entry">
          <h4>On-screen keypad</h4>
          <div class="key-grid">
            <!-- Row 1 -->
            <button type="button" class="key" data-digit="1" aria-label="1">1</button>
            <button type="button" class="key" data-digit="2" aria-label="2">2</button>
            <button type="button" class="key" data-digit="3" aria-label="3">3</button>
            <!-- Row 2 -->
            <button type="button" class="key" data-digit="4" aria-label="4">4</button>
            <button type="button" class="key" data-digit="5" aria-label="5">5</button>
            <button type="button" class="key" data-digit="6" aria-label="6">6</button>
            <!-- Row 3 -->
            <button type="button" class="key" data-digit="7" aria-label="7">7</button>
            <button type="button" class="key" data-digit="8" aria-label="8">8</button>
            <button type="button" class="key" data-digit="9" aria-label="9">9</button>
            <!-- Row 4 -->
            <button type="button" class="key action wide" id="clearKey" aria-label="Clear">Clear</button>
            <button type="button" class="key" data-digit="0" aria-label="0">0</button>
            <button type="button" class="key action" id="backspaceKey" aria-label="Backspace">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M3 12l5.5-6H21a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H8.5L3 12z" stroke="currentColor" stroke-width="1.6"/>
                <path d="M14 9l4 4M18 9l-4 4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              </svg>
            </button>
            <!-- Row 5 -->
            <button type="button" class="key action wide" id="submitKey" aria-label="Submit code">Submit</button>
          </div>
        </section>
      </div>
      <!-- /otp-wrap -->
    </form>

    <!-- RESEND FORM (separate, not nested) -->
    <form id="resendForm" method="post" action="/send-otp/whatsapp" style="margin-top:12px;">
      <input type="hidden" name="phone" value="<%= phone %>" />
      <button id="resendBtn" class="btn btn-ghost" type="submit" disabled>
        Resend <span id="resendCountdown" class="countdown"></span>
      </button>
    </form>

    <p class="subtle">Didn't receive the code? You can resend it after a few seconds.</p>
    <div class="footer">Need help? <a href="/help">Contact support</a></div>
  </div>

  <script>
    // =============================
    // OTP UX: 6 cells with auto-advance, paste, and join into hidden input
    // =============================
    (function(){
      const cells = Array.from(document.querySelectorAll('.otp-cell'));
      const hidden = document.getElementById('code');
      const form = document.getElementById('verifyForm');
      const verifyBtn = document.getElementById('verifyBtn');

      // Focus first on load
      setTimeout(()=>{ try{ cells[0].focus(); }catch(e){} }, 60);

      function normalizeDigit(str){ return (str || '').replace(/\D/g,'').slice(0,1); }

      // Handle typing and navigation
      cells.forEach((cell, idx)=>{
        cell.addEventListener('input', (e)=>{
          const v = normalizeDigit(cell.value);
          cell.value = v;
          if (v && idx < cells.length - 1) cells[idx+1].focus();
          updateHidden();
        });

        cell.addEventListener('keydown', (e)=>{
          const key = e.key;
          if (key === 'Backspace' && !cell.value && idx > 0){
            cells[idx-1].focus();
            cells[idx-1].value = '';
            updateHidden();
          }
          if (key === 'ArrowLeft' && idx > 0) { cells[idx-1].focus(); e.preventDefault(); }
          if (key === 'ArrowRight' && idx < cells.length - 1) { cells[idx+1].focus(); e.preventDefault(); }
          if (key === 'Enter') { e.preventDefault(); form.requestSubmit(); }
        });
      });

      // Paste full code into any cell
      cells.forEach(cell=>{
        cell.addEventListener('paste', (e)=>{
          const text = (e.clipboardData || window.clipboardData).getData('text');
          const digits = (text || '').replace(/\D/g,'').slice(0,6).split('');
          if (!digits.length) return;
          e.preventDefault();
          for (let i=0;i<cells.length;i++){
            cells[i].value = digits[i] || '';
          }
          (cells[digits.length] || cells[cells.length-1]).focus();
          updateHidden();
        });
      });

      function updateHidden(){
        hidden.value = cells.map(c=>c.value || '').join('');
      }

      // Expose minimal hooks for keypad (NEW)
      window.__otpCells = cells;
      window.__otpUpdateHidden = updateHidden;
      window.__otpForm = form;

      form.addEventListener('submit', (e)=>{
        updateHidden();
        const code = hidden.value;
        if (!/^\d{4,6}$/.test(code)){
          e.preventDefault();
          // brief highlight to indicate issue
          cells.forEach(c=>{ c.style.outline = '3px solid rgba(255,123,0,.18)'; });
          setTimeout(()=> cells.forEach(c=> c.style.outline=''), 800);
          (cells.find(c => !c.value) || cells[0]).focus();
          return;
        }
        verifyBtn.setAttribute('disabled','disabled');
      });
    })();
  </script>

  <script>
    // =============================
    // Resend countdown + button states + polite announcements
    // =============================
    (function(){
      const resendBtn = document.getElementById('resendBtn');
      const resendCountdown = document.getElementById('resendCountdown');
      const resendForm = document.getElementById('resendForm');

      const initialWait = Number(<%= typeof resendWait !== 'undefined' ? resendWait : 30 %>) || 30;
      let timer = null;
      let seconds = initialWait;

      function render(){
        if (seconds > 0){
          resendBtn.disabled = true;
          resendCountdown.textContent = `(${seconds}s)`;
        } else {
          resendCountdown.textContent = '';
          resendBtn.disabled = false;
        }
      }

      function start(){
        clearInterval(timer);
        render();
        if (seconds <= 0) return;
        timer = setInterval(()=>{
          seconds--; render();
          if (seconds <= 0){ clearInterval(timer); }
        }, 1000);
      }

      start();

      resendForm.addEventListener('submit', ()=>{
        resendBtn.disabled = true;
        resendBtn.textContent = 'Sending…';
      });
    })();
  </script>
  
  <script>
    // Inactivity timer: 30s -> redirect to '/'
    (function(){
      const TIMEOUT_MS = 30000; // 30 seconds
      let timer;
      const events = ['mousemove','keydown','touchstart','click','focusin'];
      function reset(){
        if (timer) clearTimeout(timer);
        timer = setTimeout(()=>{
          if (document.visibilityState === 'visible') {
            window.location.href = '/';
          }
        }, TIMEOUT_MS);
      }
      events.forEach(evt => document.addEventListener(evt, reset, { passive: true }));
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          if (timer) clearTimeout(timer);
        } else {
          reset();
        }
      });
      reset();

      // Back button behavior
      const backBtn = document.getElementById('backBtn');
      if (backBtn){
        backBtn.addEventListener('click', (e)=>{
          e.preventDefault();
          window.location.href = '/';
        });
      }
    })();
  </script>

  <!-- EXTRA inactivity timer existed in your snippet (20s). Keep if you want stricter timeout; otherwise remove. -->
  <script>
  (function(){
    let timer;
    function resetTimer() {
      clearTimeout(timer);
      timer = setTimeout(() => { window.location.href = '/'; }, 20000); // 20 seconds
    }
    ['mousemove','keydown','click','touchstart'].forEach(evt =>
      document.addEventListener(evt, resetTimer)
    );
    resetTimer();
  })();
  </script>

  <!-- =============================
       Virtual Keypad Logic (NEW)
       ============================= -->
  <script>
    (function(){
      const grid = document.querySelector('.key-grid');
      if (!grid) return;

      const cells = window.__otpCells || Array.from(document.querySelectorAll('.otp-cell'));
      const updateHidden = window.__otpUpdateHidden || function(){
        const hidden = document.getElementById('code');
        hidden.value = cells.map(c=>c.value || '').join('');
      };
      const form = window.__otpForm || document.getElementById('verifyForm');
      const submitKey = document.getElementById('submitKey');
      const backspaceKey = document.getElementById('backspaceKey');
      const clearKey = document.getElementById('clearKey');

      function firstEmptyIndex(){
        return cells.findIndex(c => !c.value);
      }
      function lastFilledIndex(){
        let idx = -1;
        for (let i=0;i<cells.length;i++){ if (cells[i].value) idx = i; }
        return idx;
      }
      function pushDigit(d){
        const idx = firstEmptyIndex();
        if (idx === -1) return; // full
        cells[idx].value = String(d).replace(/\D/g,'').slice(0,1);
        // trigger native input handlers (auto-advance + updateHidden)
        cells[idx].dispatchEvent(new Event('input', { bubbles:true }));
        cells[Math.min(idx+1, cells.length-1)].focus({ preventScroll:true });
      }
      function backspaceOnce(){
        let idx = lastFilledIndex();
        if (idx < 0) return;
        cells[idx].value = '';
        // update hidden and focus
        updateHidden();
        cells[idx].focus({ preventScroll:true });
      }
      function clearAll(){
        cells.forEach(c => c.value = '');
        updateHidden();
        cells[0].focus({ preventScroll:true });
      }
      function maybeAutoSubmit(){
        const code = cells.map(c=>c.value).join('');
        if (/^\d{6}$/.test(code)){
          form.requestSubmit();
        }
      }

      // Digit clicks
      grid.querySelectorAll('[data-digit]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          pushDigit(btn.getAttribute('data-digit'));
          maybeAutoSubmit();
        });
      });

      // Backspace: click + press-and-hold
      let holdTimer, holdInterval;
      const startHold = ()=>{
        backspaceOnce();
        holdTimer = setTimeout(()=>{ holdInterval = setInterval(backspaceOnce, 60); }, 350);
      };
      const endHold = ()=>{
        clearTimeout(holdTimer); clearInterval(holdInterval);
      };
      ['mousedown','touchstart'].forEach(evt => backspaceKey.addEventListener(evt, e => { e.preventDefault(); startHold(); }));
      ['mouseup','mouseleave','touchend','touchcancel'].forEach(evt => backspaceKey.addEventListener(evt, endHold));
      backspaceKey.addEventListener('click', e => e.preventDefault());

      // Clear
      clearKey.addEventListener('click', e => { e.preventDefault(); clearAll(); });

      // Submit
      submitKey.addEventListener('click', e => { e.preventDefault(); form.requestSubmit(); });
    })();
  </script>
</body>  
</html>
