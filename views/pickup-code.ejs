<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Access Code Unlock</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
  /* prevent scrolling and ensure full-screen fixed layout */
  html, body{
    height: 100dvh; /* better on mobile than 100vh */
    margin: 0;
    overflow: hidden; /* make unscrollable */
    -webkit-overflow-scrolling: auto;
    box-sizing: border-box;
  }
  *, *::before, *::after{ box-sizing: inherit; }

  body{
    background:#ffffff;
    background-size:400% 400%;
    animation:gradientFlow 12s ease infinite;
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif;
    min-height:100dvh;
    display:flex;
    justify-content:center;
    align-items:center;
    color:#fff;
    padding:0;
  }

  /* center panel */
  .unlock-box{
    background:black;
    border-radius:18px;
    padding: clamp(20px, 3vw, 36px);
    text-align:center;
    box-shadow:0 0 35px rgba(0,255,255,.3);
    backdrop-filter:blur(12px);
    width: min(680px, 96vw);
    max-width: 96vw;
    height: min(88dvh, 820px);
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    gap: clamp(14px, 2.2vw, 20px);
  }

  /* larger code display but fluid */
  .code-input{
    font-size: clamp(28px, 6vw, 40px);
    text-align:center;
    letter-spacing: clamp(6px, 2vw, 12px);
    border:none; outline:none;
    background:transparent; color:#00f5ff;
    font-weight:800;
    margin-bottom:0;
    width:100%;
    max-width: 32ch;
  }

  h3.mb-3{
    margin:6px 0 8px 0;
    color:#fff; font-weight:700;
    font-size: clamp(18px, 3.5vw, 24px);
  }

  /* RESPONSIVE KEYPAD */
  .keyboard{
    display:grid;
    grid-template-columns: repeat(3, minmax(68px, 1fr));
    gap: clamp(10px, 2.8vw, 18px);
    margin-bottom:0;
    justify-items:stretch;
    width: min(92vw, 520px);
    max-width: 42ch; /* prevents super-wide stretch on tablets */
  }

  .key{
    background: linear-gradient(135deg,#0077ff,#00ffff);
    border:none;
    border-radius: 14px;
    /* Keep buttons square and scalable */
    aspect-ratio: 1 / 1;
    min-width: 64px;
    min-height: 64px;
    /* No fixed padding/height – let aspect-ratio control it */
    font-size: clamp(20px, 6.4vw, 26px);
    font-weight:800; color:#fff;
    box-shadow:0 0 16px rgba(0,255,255,.6);
    cursor:pointer; transition:.14s;
    display:inline-flex; align-items:center; justify-content:center;
    user-select:none;
    -webkit-tap-highlight-color: transparent;
  }

  .key:hover{ box-shadow:0 0 30px rgba(0,255,255,.95); transform:scale(1.03); }
  .key:active{ transform: translateY(2px) scale(.995); }
  .key:focus-visible{
    outline: 3px solid #ff7b00;
    outline-offset: 3px;
  }

  .submit-btn{
    background: linear-gradient(135deg,#ff7b00,#ff4500);
    color:#fff; border:none;
    padding: clamp(12px, 2vw, 16px);
    width:100%; border-radius:12px;
    font-size: clamp(16px, 3.5vw, 20px);
    font-weight:800;
    box-shadow:0 0 20px rgba(255,128,0,.6);
    transition:.18s;
    max-width: 42ch;
  }
  .submit-btn:hover{ box-shadow:0 0 30px rgba(255,128,0,1); transform:scale(1.02); }
  .submit-btn.mt-3{ margin-top:12px; background:#888; }

  /* Modal & Locker (unchanged but fluid text) */
  .locker-scene{ perspective:1200px; width:220px; height:320px; margin:0 auto; }
  .modal-content{ background:rgba(10,10,30,.95); border-radius:15px; color:#fff; box-shadow:0 0 30px rgba(0,255,255,.4); }
  .modal-title i{ color:#00ffff; }
  #lockerActionText{ font-weight:600; font-size: clamp(1rem, 2.8vw, 1.15rem); color:#fff; }
  #lockerSubNote{ font-size:.95rem; color:#ccc; }
  .modal{ z-index:1060; }
  .modal-backdrop{ z-index:1050; }

  /* Very small phones */
  @media (max-width:420px){
    .unlock-box{
      padding: clamp(16px, 4vw, 22px);
      width: 94vw;
      border-radius:14px;
      height: 92dvh;
      gap: clamp(12px, 3vw, 16px);
    }
    .keyboard{
      gap: clamp(8px, 2.8vw, 12px);
      max-width: 36ch;
    }
    .key{
      min-width: 56px;
      min-height: 56px;
      border-radius:12px;
      font-size: clamp(18px, 7vw, 22px);
    }
    .locker-scene{ width:160px; height:220px; }
  }

  /* Landscape phones/tablets: reduce vertical footprint a bit */
  @media (orientation: landscape) and (max-height: 520px){
    .unlock-box{
      height: auto;
      padding: clamp(16px, 3vw, 24px);
    }
    .keyboard{
      gap: clamp(8px, 2vw, 14px);
      max-width: 48ch;
    }
  }

  .red-warning{
    color:#ff3b30; font-weight:900; text-transform:uppercase;
    letter-spacing:.5px; margin-top:12px; line-height:1.2;
    animation:pulseWarn 1s ease-in-out infinite;
    font-size: clamp(12px, 2.8vw, 14px);
  }
  @keyframes pulseWarn{
    0%{ opacity:.75 }
    50%{ opacity:1; text-shadow:0 0 12px rgba(255,59,48,.7); }
    100%{ opacity:.75 }
  }

  /* Respect reduced motion users */
  @media (prefers-reduced-motion: reduce){
    *{ animation: none !important; transition: none !important; }
  }
  /* Landscape tablet tuning */
@media (orientation: landscape) and (min-width: 900px) {
  /* Let the panel breathe vertically on short heights */
  .unlock-box{
    height: 750px;                /* don't force tall vh in landscape */
    padding-block: clamp(12px, 3vh, 24px);
    width: min(1000px, 96vw);
    gap: clamp(12px, 2vh, 20px);
  }

  /* Make the keypad height-driven so 4 rows always fit */
  .keyboard{
    /* Use the short side (vh) to size the area */
    height: min(62vh, 520px);    /* fits 4 rows on iPad / Android tablets */
    max-width: min(70vw, 720px); /* avoid over-wide stretch */
    width: 100%;

    /* Let the grid rows define button height instead of aspect-ratio */
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(4, 1fr);
    grid-auto-rows: 1fr;
    gap: clamp(10px, 1.6vh, 18px);
  }

  /* Buttons fill their grid cells; font scales with vh so it’s legible */
  .key{
    aspect-ratio: auto;          /* override the square constraint */
    height: 100%;
    min-height: 0;               /* allow shrinking within the row */
    min-width: 0;
    font-size: clamp(18px, 3.2vh, 28px);
    border-radius: clamp(10px, 1.2vh, 14px);
  }

  /* Inputs & headings scale a touch smaller to save vertical space */
  .code-input{
    font-size: clamp(22px, 3.6vh, 34px);
    letter-spacing: clamp(6px, 1vh, 10px);
    max-width: 30ch;
  }

  h3.mb-3{
    font-size: clamp(16px, 2.6vh, 22px);
    margin: 4px 0 6px;
  }

  .submit-btn{
    max-width: 40ch;
    padding: clamp(10px, 1.6vh, 14px);
    font-size: clamp(15px, 2.4vh, 18px);
  }
}

/* Extra: very short landscapes (e.g., split view or small tablets) */
@media (orientation: landscape) and (max-height: 520px){
  .keyboard{
    height: min(58vh, 440px);
    gap: clamp(8px, 1.2vh, 12px);
  }
  .key{
    font-size: clamp(16px, 2.8vh, 22px);
  }
}

</style>

</head>

<body>
  <div class="unlock-box">
    <img src="/images/droppointlogo.png" style="height:90px;width:250px" alt="Droppoint logo">
    <h3 class="mb-3">Enter Access Code</h3>
    <!-- Use readonly (not disabled) so script can set/read value and keep native styles -->
    <input type="text" inputmode="numeric" pattern="[0-9]*" id="accessCode" class="code-input" maxlength="6" readonly>

    <div class="keyboard">
      <% for(let i=1; i<=9; i++){ %>
        <button class="key" type="button" onclick="pressKey('<%= i %>')">
          <%= i %>
        </button>
        <% } %>
          <button class="key" type="button" onclick="clearCode()">C</button>
          <button class="key" type="button" onclick="pressKey('0')">0</button>
          <button class="key" type="button" onclick="deleteKey()">⌫</button>
    </div>

    <button class="submit-btn" type="button" onclick="submitCode()">Unlock</button>
    <button class="submit-btn mt-3" style="background:#888" type="button" onclick="goBack()">Go Back</button>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="lockerAssignedModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <div class="modal-header border-0 justify-content-center">
          <h5 class="modal-title w-100"><i class="bi bi-box-seam-fill me-2"></i> Locker Unlocked</h5>
        </div>
        <div class="modal-body">
          <h1 id="assignedLockerId" class="display-3 fw-bold text-warning">--</h1>
          <p id="lockerActionText" class="mb-3"></p>
          <div class="locker-scene mt-3">
            <i class="fa-solid fa-lock-open fa-shake" style="font-size:5rem"></i>
          </div>
          <p id="closeWarning" class="red-warning" role="alert" aria-live="assertive">
            CLOSE THE LOCKER FIRMLY AFTER YOU’RE DONE
          </p>
        </div>
        <p id="lockerSubNote" class="mt-3 small">Door will open automatically</p>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function goBack() { window.location.href = '/pickup'; }


  function showAssignedModal(compartmentId, parcelStatus){
    const modalEl = document.getElementById('lockerAssignedModal');
    if(modalEl.parentElement !== document.body){ document.body.appendChild(modalEl); }

    document.getElementById('assignedLockerId').textContent = 'C' + compartmentId;
    const actionText = document.getElementById('lockerActionText');
    const subNote = document.getElementById('lockerSubNote');
    const closeWarn = document.getElementById('closeWarning');

    if(parcelStatus === 'awaiting_drop'){
      actionText.textContent = 'Please drop your parcel inside the locker';
      subNote.textContent = 'Door will open for dropping';
      if(closeWarn) closeWarn.textContent = 'AFTER DROPPING, CLOSE THE LOCKER FIRMLY';
    } else if(parcelStatus === 'awaiting_pick'){
      actionText.textContent = 'Please pick up your parcel';
      subNote.textContent = 'Door will open for collection';
      if(closeWarn) closeWarn.textContent = 'AFTER PICKUP, CLOSE THE LOCKER FIRMLY';
    } else {
      actionText.textContent = 'Proceed to your locker';
      subNote.textContent = 'Door will open automatically';
      if(closeWarn) closeWarn.textContent = 'CLOSE THE LOCKER FIRMLY AFTER YOU’RE DONE';
    }

    // Reset listeners and show
    modalEl.replaceWith(modalEl.cloneNode(true));
    const freshModalEl = document.getElementById('lockerAssignedModal');
    const modal = bootstrap.Modal.getOrCreateInstance(freshModalEl);
    modal.show();

    // Auto close after 5s
    setTimeout(() => modal.hide(), 5000);
  }



    function pressKey(num) {
      const input = document.getElementById('accessCode');
      if (input.value.length >= 6) return;
      input.value = (input.value + String(num)).slice(0, 6);
    }
    function deleteKey() { const i = document.getElementById('accessCode'); i.value = i.value.slice(0, -1); }
    function clearCode() { document.getElementById('accessCode').value = ''; }

    function submitCode() {
      const code = document.getElementById('accessCode').value.trim();
      if (code.length !== 6) { alert('Please enter your 6-digit code'); return; }

      fetch('/api/locker/unlock-code', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ accessCode: code, lockerId: 'L166' })
      })
        .then(async res => {
          const data = await res.json().catch(() => ({}));
          if (!res.ok) { throw new Error(data && data.message ? data.message : `Request failed (${res.status})`); }
          return data;
        })
        .then(data => {
          if (data && data.success && data.compartmentId) {
            showAssignedModal(data.compartmentId, data.parcelStatus);
            clearCode();
          } else {
            alert((data && data.message) || 'Something went wrong!');
          }
        })
        .catch(err => { console.error(err); alert(err.message || 'Error verifying code.'); });
    }
  </script>

  <script>
    // inactivity redirect
    let inactivityTimer;
    function resetInactivityTimer() { clearTimeout(inactivityTimer); inactivityTimer = setTimeout(() => { window.location.href = '/'; }, 20000); }
    ['mousemove', 'keydown', 'click', 'touchstart'].forEach(evt => document.addEventListener(evt, resetInactivityTimer));
    resetInactivityTimer();
  </script>
</body>

</html> 